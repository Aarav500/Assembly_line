name: Deploy to VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VM_IP: 140.245.12.100
  VM_USER: ubuntu
  PROJECT_DIR: unified_app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Create .env file from secret
        run: |
          cat << 'EOF' > .env
          ${{ secrets.ENV }}
          EOF
          echo "âœ… .env file created from GitHub secret"

      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Verify key format
          if ! ssh-keygen -l -f ~/.ssh/id_ed25519 > /dev/null 2>&1; then
            echo "âŒ SSH key format invalid!"
            echo "Key preview (first 50 chars):"
            head -c 50 ~/.ssh/id_ed25519
            exit 1
          fi
          ssh-keyscan -H ${{ env.VM_IP }} >> ~/.ssh/known_hosts
          echo "âœ… SSH key configured"

      - name: ğŸ”Œ Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} "echo 'âœ… SSH connection successful'"

      - name: ğŸ³ Check Docker Installation
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker not installed. Installing..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              echo "âœ… Docker installed"
            else
              echo "âœ… Docker already installed"
              docker --version
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "âŒ Docker Compose not installed. Installing..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "âœ… Docker Compose installed"
            else
              echo "âœ… Docker Compose already installed"
              docker-compose --version
            fi
          ENDSSH

      - name: ğŸ“ Create Project Directory on VM
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            mkdir -p ~/${{ env.PROJECT_DIR }}
            echo "âœ… Project directory created"
          ENDSSH

      - name: ğŸ“¤ Copy Files to VM
        run: |
          echo "Copying files to VM..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='**/.venvs' \
            --exclude='**/venv' \
            --exclude='**/__pycache__' \
            --exclude='**/*.pyc' \
            --exclude='**/logs/*' \
            --exclude='**/data/*' \
            --exclude='.env.local' \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            ./ ${{ env.VM_USER }}@${{ env.VM_IP }}:~/${{ env.PROJECT_DIR }}/
          echo "âœ… Files copied to VM"

      - name: ğŸ” Copy .env to VM
        run: |
          scp -i ~/.ssh/id_ed25519 .env ${{ env.VM_USER }}@${{ env.VM_IP }}:~/${{ env.PROJECT_DIR }}/.env
          echo "âœ… .env file copied to VM"

      - name: ğŸ”¥ Configure Firewall
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            echo "Configuring firewall..."
            sudo ufw allow 22/tcp || true
            sudo ufw allow 80/tcp || true
            sudo ufw allow 443/tcp || true
            sudo ufw allow 3000/tcp || true
            sudo ufw allow 5000/tcp || true
            sudo ufw allow 8080/tcp || true
            echo "âœ… Firewall configured"
          ENDSSH

      - name: ğŸ›‘ Stop Existing Services
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            if [ -f docker-compose.yml ]; then
              echo "Stopping existing services..."
              docker-compose down || true
              echo "âœ… Services stopped"
            fi
          ENDSSH

      - name: ğŸ”¨ Build Docker Images
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            echo "=========================================="
            echo "Building Docker images..."
            echo "=========================================="
            echo "This will:"
            echo "  âœ“ Build backend, frontend, infrastructure images"
            echo "  âœ“ Process all modules (001, 002, etc.)"
            echo "  âœ“ Create virtual environments automatically"
            echo "  âœ“ Detect dependency conflicts"
            echo "  âœ“ Assign modules to compatible venvs"
            echo ""
            echo "Starting build process..."
            docker-compose build --no-cache
            echo ""
            echo "âœ… Docker images built successfully"
            echo "=========================================="
          ENDSSH

      - name: ğŸš€ Start Services
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            echo "=========================================="
            echo "Starting all services..."
            echo "=========================================="
            docker-compose up -d
            echo ""
            echo "âœ… All services started"
            echo "=========================================="
          ENDSSH

      - name: â³ Wait for Services to Initialize
        run: |
          echo "Waiting 30 seconds for services to fully start..."
          sleep 30
          echo "âœ… Wait complete"

      - name: ğŸ“Š Check Container Status
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            echo ""
            echo "=========================================="
            echo "Container Status:"
            echo "=========================================="
            docker-compose ps
            echo "=========================================="
          ENDSSH

      - name: ğŸ“‹ Display Backend VEnv Report
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            if [ -f backend/venv_report.txt ]; then
              echo ""
              echo "=========================================="
              echo "ğŸ“¦ Backend Virtual Environments:"
              echo "=========================================="
              head -n 25 backend/venv_report.txt
              echo "=========================================="
            fi
          ENDSSH

      - name: ğŸ“‹ Display Frontend VEnv Report
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            if [ -f frontend/venv_report.txt ]; then
              echo ""
              echo "=========================================="
              echo "ğŸ“¦ Frontend Virtual Environments:"
              echo "=========================================="
              head -n 25 frontend/venv_report.txt
              echo "=========================================="
            fi
          ENDSSH

      - name: ğŸ“‹ Display Infrastructure VEnv Report
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            if [ -f infrastructure/venv_report.txt ]; then
              echo ""
              echo "=========================================="
              echo "ğŸ“¦ Infrastructure Virtual Environments:"
              echo "=========================================="
              head -n 25 infrastructure/venv_report.txt
              echo "=========================================="
            fi
          ENDSSH

      - name: ğŸ“Š Display VEnv Summary Statistics
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            echo ""
            echo "=========================================="
            echo "ğŸ“Š VEnv Summary Statistics:"
            echo "=========================================="
            
            if [ -f backend/venv_mapping.json ]; then
              echo "Backend:"
              echo "  Total Modules: $(cat backend/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('module_venv_map', {})))" 2>/dev/null || echo "N/A")"
              echo "  Total VEnvs: $(cat backend/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('venv_requirements', {})))" 2>/dev/null || echo "N/A")"
            fi
            
            if [ -f frontend/venv_mapping.json ]; then
              echo "Frontend:"
              echo "  Total Modules: $(cat frontend/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('module_venv_map', {})))" 2>/dev/null || echo "N/A")"
              echo "  Total VEnvs: $(cat frontend/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('venv_requirements', {})))" 2>/dev/null || echo "N/A")"
            fi
            
            if [ -f infrastructure/venv_mapping.json ]; then
              echo "Infrastructure:"
              echo "  Total Modules: $(cat infrastructure/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('module_venv_map', {})))" 2>/dev/null || echo "N/A")"
              echo "  Total VEnvs: $(cat infrastructure/venv_mapping.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('venv_requirements', {})))" 2>/dev/null || echo "N/A")"
            fi
            
            echo "=========================================="
          ENDSSH

      - name: ğŸ¥ Backend Health Check
        run: |
          echo "Checking backend health..."
          response=$(curl -s -f http://${{ env.VM_IP }}:5000/health)
          echo "$response"
          if echo "$response" | grep -q "healthy"; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi

      - name: ğŸ¥ Frontend Health Check
        run: |
          echo "Checking frontend health..."
          response=$(curl -s -f http://${{ env.VM_IP }}:3000/health)
          echo "$response"
          if echo "$response" | grep -q "healthy"; then
            echo "âœ… Frontend is healthy"
          else
            echo "âŒ Frontend health check failed"
            exit 1
          fi

      - name: ğŸ¥ Infrastructure Health Check
        run: |
          echo "Checking infrastructure health..."
          response=$(curl -s -f http://${{ env.VM_IP }}:8080/health)
          echo "$response"
          if echo "$response" | grep -q "healthy"; then
            echo "âœ… Infrastructure is healthy"
          else
            echo "âŒ Infrastructure health check failed"
            exit 1
          fi

      - name: ğŸŒ Display Access URLs
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ‰ Deployment Successful!"
          echo "=========================================="
          echo ""
          echo "ğŸ“± Access your application:"
          echo ""
          echo "  ğŸŒ Frontend:       http://${{ env.VM_IP }}:3000"
          echo "  ğŸ”§ Backend API:    http://${{ env.VM_IP }}:5000"
          echo "  ğŸ“Š Monitoring:     http://${{ env.VM_IP }}:8080"
          echo ""
          echo "ğŸ–¥ï¸  VM IP: ${{ env.VM_IP }}"
          echo "ğŸ“ Project Dir: ~/${{ env.PROJECT_DIR }}"
          echo ""
          echo "âœ… All services are running and healthy!"
          echo "=========================================="

      - name: ğŸ§¹ Cleanup Old Docker Resources
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            echo "Cleaning up unused Docker resources..."
            docker system prune -f
            echo "âœ… Cleanup complete"
          ENDSSH

      - name: ğŸ’¾ Display Disk Usage
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            echo ""
            echo "=========================================="
            echo "ğŸ’¾ Disk Usage:"
            echo "=========================================="
            df -h | grep -E "Filesystem|/$"
            echo "=========================================="
          ENDSSH

      - name: ğŸ“ Display Service Logs Preview
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            cd ~/${{ env.PROJECT_DIR }}
            echo ""
            echo "=========================================="
            echo "ğŸ“ Recent Service Logs (last 10 lines):"
            echo "=========================================="
            echo ""
            echo "Backend logs:"
            docker-compose logs --tail=10 backend
            echo ""
            echo "=========================================="
          ENDSSH

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "âŒ Deployment Failed!"
          echo "=========================================="
          echo ""
          echo "Common issues:"
          echo "  1. SSH key not configured correctly"
          echo "  2. ENV secret not set or invalid"
          echo "  3. Docker not installed on VM"
          echo "  4. Firewall blocking ports"
          echo "  5. Insufficient disk space on VM"
          echo "  6. Module requirements conflicts"
          echo ""
          echo "Check the logs above for details"
          echo "=========================================="
          echo ""
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH' || true
            cd ~/${{ env.PROJECT_DIR }}
            echo "Container status:"
            docker-compose ps
            echo ""
            echo "Recent error logs:"
            docker-compose logs --tail=50
          ENDSSH