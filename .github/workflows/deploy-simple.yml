name: Deploy Unified App

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VM_IP: 100.31.44.107
  VM_USER: ubuntu
  PROJECT_DIR: unified_app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.VM_IP }} >> ~/.ssh/known_hosts

      - name: Sync files to VM
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.venv' \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ ${{ env.VM_USER }}@${{ env.VM_IP }}:~/${{ env.PROJECT_DIR }}/

      - name: Deploy on VM
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ env.VM_USER }}@${{ env.VM_IP }} << 'ENDSSH'
            set -e
            cd ~/${{ env.PROJECT_DIR }}

            # Stop existing services
            docker-compose -f docker-compose.simple.yml down || true

            # Build and start
            docker-compose -f docker-compose.simple.yml build
            docker-compose -f docker-compose.simple.yml up -d

            # Wait for health check
            sleep 10

            # Show status
            docker-compose -f docker-compose.simple.yml ps
          ENDSSH

      - name: Health Check
        run: |
          for i in {1..12}; do
            if curl -fsS "http://${{ env.VM_IP }}/health" >/dev/null; then
              echo "Deployment successful!"
              exit 0
            fi
            echo "Waiting for service..."
            sleep 10
          done
          echo "Health check failed"
          exit 1

      - name: Deployment Complete
        run: |
          echo "========================================="
          echo "DEPLOYMENT SUCCESSFUL"
          echo "========================================="
          echo "URL: http://${{ env.VM_IP }}"
          echo "API: http://${{ env.VM_IP }}/api/services"
          echo "Health: http://${{ env.VM_IP }}/health"
